package com.exseed.login.view

import android.animation.*
import android.app.Activity
import android.content.Intent
import android.graphics.Color
import android.graphics.Point
import android.os.Build
import android.os.Bundle
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.view.WindowManager
import androidx.annotation.RequiresApi
import androidx.core.content.ContextCompat
import androidx.core.graphics.ColorUtils
import androidx.fragment.app.Fragment
import androidx.localbroadcastmanager.content.LocalBroadcastManager
import com.exseed.R
import com.exseed.model.LanguageModel
import kotlinx.android.synthetic.main.wizard_semen_colour_picker_view.*


class LanguagePickerViewFragment() : Fragment() {


    private var selectedItem = LanguageModel()
    private var selectedItemPosition = 0

    var statusBarDark = false

    private var yearList: List<LanguageModel> = mutableListOf()

    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {
        requireActivity().overridePendingTransition(0, 0)
        return inflater.inflate(R.layout.activity_create_profile_picker_view, container, false)
    }

    override fun onResume() {
        super.onResume()

//    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
//        super.onViewCreated(view, savedInstanceState)


        // Fade Animation for the Semi-Transparent Black Background
        // Get the size of the size
        val mDisplay = requireActivity().windowManager.defaultDisplay
        val mDisplaySize = Point()
        mDisplay.getSize(mDisplaySize)
        val maxX = mDisplaySize.x
        val maxY = mDisplaySize.y

        // Set the background same as Display height
        pickerviewbg.y = maxY.toFloat()
        val alpha = 85 // Set Between 0-255
        val alphaColor = ColorUtils.setAlphaComponent(Color.BLACK, alpha)
        val colorAnimation = ValueAnimator.ofObject(ArgbEvaluator(), Color.TRANSPARENT, alphaColor)
        colorAnimation.duration = 500 // milliseconds
        colorAnimation.addUpdateListener { animator -> pickerviewtransbg.setBackgroundColor(animator.animatedValue as Int) }
        colorAnimation.start()

        yearList = mutableListOf(
            LanguageModel(
                getString(R.string.settings_language_option_English),
                ContextCompat.getDrawable(requireContext(), R.drawable.en_with_circle)
            ),
            LanguageModel(
                getString(R.string.settings_language_option_swedish),
                ContextCompat.getDrawable(requireContext(), R.drawable.sv_with_circle)
            ),
            LanguageModel(
                getString(R.string.settings_language_option_italian),
                ContextCompat.getDrawable(requireContext(), R.drawable.it_with_circle)
            ),
            LanguageModel(
                getString(R.string.settings_language_option_french),
                ContextCompat.getDrawable(requireContext(), R.drawable.fr_with_circle)
            ),
            LanguageModel(
                getString(R.string.settings_language_option_German),
                ContextCompat.getDrawable(requireContext(), R.drawable.de_with_circle)
            ),
            LanguageModel(
                getString(R.string.settings_language_option_Spanish),
                ContextCompat.getDrawable(requireContext(), R.drawable.es_with_circle)
            ),


        )

        // Empty click listener helps to stop the view from closing when you tap 'outside'
        barview.setOnClickListener { }

        // WheelView Customization
        val wheelView = requireActivity().findViewById<WheelViewImage>(R.id.wheelview)
        wheelView.selectedItemColor = R.color.text_black
        wheelView.unselectedItemColor = R.color.text_black
        wheelView.linesColor = R.color.text_black

        wheelView.itemTextSize = 25f
        //val font = ResourcesCompat.getFont(this, R.font.roboto)
        //wheelView.itemFont = font

        // Amount of items above and below the selected item
        wheelView.offset = 1


//
//        // Check if default value exists, if not then show the first item of on the wheelView
//        if (yearList.contains(defaultValue)) {
//            val valueIndex = yearList.indexOf(defaultValue)
//            wheelView.setSelection(valueIndex)
//        } else {
//            wheelView.setSelection(0)
//        }
//
        // Add the list of items to the wheelView
        wheelView.setItemsColour(yearList)
//
//        // Set the value you see once you open the PickerView as selected item, this will change later with the onWheelViewListener
//        selectedItem = wheelView.getSelectedItem

        // Set the position of the value you see once you open the PickerView as selected item position, this will change later with the onWheelViewListener
        selectedItemPosition = wheelView.getSelectedIndex

        // Returns the current selected item and position of the item after you scroll up/down
        wheelView.onWheelViewListener = object : WheelViewImage.OnWheelViewListener() {
            override fun onSelected(selectedIndex: Int, item: LanguageModel) {
                selectedItem = item
                selectedItemPosition = selectedIndex
                // Return results to the MainActivity
                returnResultsBack()

                // Close PickerView
                onBackPressed()

            }
        }

        donebtn.setTextColor(Color.WHITE)


        // Returns the final selected item and position after you pressed 'Done'
        donebtn.setOnClickListener {
            onBackPressed()


        }


        slideUp(pickerviewbg)

    }

    private fun returnResultsBack() {
        val intent = Intent("languageSetup")
        intent.putExtra("selectedItem", selectedItem.title)
        LocalBroadcastManager.getInstance(requireContext()).sendBroadcast(intent)
    }

    @RequiresApi(Build.VERSION_CODES.KITKAT)
    private fun setWindowFlag(activity: Activity, on: Boolean) {
        val win = activity.window
        val winParams = win.attributes
        if (on) {
            winParams.flags = winParams.flags or WindowManager.LayoutParams.FLAG_TRANSLUCENT_STATUS
        } else {
            winParams.flags =
                winParams.flags and WindowManager.LayoutParams.FLAG_TRANSLUCENT_STATUS.inv()
        }
        win.attributes = winParams
    }

    fun onBackPressed() {
        // Fade-Out Animation the Semi-Transparent Black Background
        // Close PickerView with slide down animation
        val alpha = 85 //between 0-255
        val alphaColor = ColorUtils.setAlphaComponent(Color.BLACK, alpha)
        val colorAnimation = ValueAnimator.ofObject(ArgbEvaluator(), alphaColor, Color.TRANSPARENT)
        colorAnimation.duration = 500 // milliseconds
        colorAnimation.addUpdateListener { animator -> pickerviewtransbg.setBackgroundColor(animator.animatedValue as Int) }
        slideDown(pickerviewbg)
        colorAnimation.addListener(object : AnimatorListenerAdapter() {
            override fun onAnimationEnd(animation: Animator) {
                activity?.onBackPressed()
            }
        })
        colorAnimation.start()
    }


    // Slide the view from its current position to below itself
    private fun slideUp(view: View) {
        ObjectAnimator.ofFloat(view, "translationY", 0f).apply {
            duration = 600
            start()
        }
    }

    // Slide the view from below itself to the current position
    private fun slideDown(view: View) {
        val mDisplay = requireActivity().windowManager.defaultDisplay
        val mDisplaySize = Point()
        mDisplay.getSize(mDisplaySize)
        val maxY = mDisplaySize.y
        val animation = ObjectAnimator.ofFloat(view, "translationY", maxY.toFloat())
        animation.duration = 600
        animation.start()
    }

//    fun onWindowFocusChanged(hasFocus: Boolean) {
//        super.onWindowFocusChanged(hasFocus)
//        slideUp(pickerviewbg)
//    }

}
